# SEO Fixes - January 25, 2026

## Issue

Google Search Console reported indexing problems:

| Issue | Count | Severity |
|-------|-------|----------|
| Soft 404 | 340 | High |
| Discovered – not indexed | 4,348 | Normal |
| Crawled – not indexed | 503 | Medium |
| Duplicate content (potential) | - | Medium |

## Root Cause Analysis

### Soft 404s (340 pages)
The listing detail page (`/listing/[id]`) returned HTTP 200 even when listings were missing or sold. Google flagged these as "soft 404s" because:
- Page returned 200 OK status
- Content showed "Listing not found" or minimal content
- Google detected mismatch between status code and content

### Share Proxy Duplicate Content
The share proxy (`/s/[id]`) had `robots: { index: true }`, potentially causing Google to index both `/s/123` and `/listing/123` as separate pages despite canonical tags.

## Fixes Implemented

### 1. Proper 404 for Missing Listings
**File:** `src/app/listing/[id]/page.tsx`

```typescript
import { notFound } from 'next/navigation';

// Invalid ID - return 404
if (isNaN(listingId)) {
  notFound();
}

// Listing doesn't exist - return proper HTTP 404
if (!listing || error) {
  notFound();
}
```

**Result:** Missing listings now return HTTP 404 instead of HTTP 200 with error content.

### 2. Noindex for Sold Items
**File:** `src/app/listing/[id]/page.tsx`

```typescript
const isSold = listing.is_sold || !listing.is_available;

return {
  // ... other metadata
  robots: isSold ? { index: false, follow: true } : { index: true, follow: true },
};
```

**Result:** Sold items remain viewable but Google will deindex them over time.

### 3. Noindex for Share Proxy
**File:** `src/app/s/[id]/page.tsx`

```typescript
robots: {
  index: false,  // Changed from true
  follow: true,
},
```

**Result:** Share proxy URLs won't be indexed, preventing duplicate content with `/listing/[id]`.

### 4. Updated Description for Sold Items
**File:** `src/app/listing/[id]/page.tsx`

```typescript
description += isSold
  ? `. ${price}. Previously listed by ${dealerName} on Nihontowatch.`
  : `. ${price}. Available from ${dealerName} on Nihontowatch.`;
```

**Result:** Meta descriptions accurately reflect item availability.

## Tests Added

**File:** `tests/app/listing-page-seo.test.ts` (8 tests)

| Test | Purpose |
|------|---------|
| notFound() for missing listing | Verifies HTTP 404 for non-existent listings |
| notFound() for invalid ID | Verifies HTTP 404 for malformed IDs |
| noindex for sold items | Verifies `robots.index = false` when `is_sold = true` |
| noindex for unavailable items | Verifies `robots.index = false` when `is_available = false` |
| index: true for available items | Verifies available items are indexed |
| "Previously listed" description | Verifies sold items don't say "Available" |
| "Available from" description | Verifies available items say "Available" |
| Share proxy noindex | Verifies `/s/[id]` has `index: false` |

## Deployment

- **Commit:** `b00fb69` - test: Add SEO tests for listing page notFound and noindex behavior
- **Branch:** main
- **Deployed:** Auto-deploy via Vercel

## Expected Results

| Issue | Expected Change | Timeline |
|-------|-----------------|----------|
| Soft 404 (340) | Drop to ~0 | 2-4 weeks |
| Duplicate content | Prevented | Immediate |
| Crawled not indexed (503) | Decrease | 2-4 weeks |

## Validation Steps

1. Go to Google Search Console → Pages
2. Click "Soft 404" issue
3. Click "Validate Fix"
4. Monitor over 2-4 weeks

## Files Changed

| File | Change |
|------|--------|
| `src/app/listing/[id]/page.tsx` | Added notFound(), noindex for sold, updated description |
| `src/app/s/[id]/page.tsx` | Changed to noindex |
| `tests/app/listing-page-seo.test.ts` | New test file (8 tests) |
